extends ../../layouts/default
include ../../mixins/icons

block head
  style.
    .num{ text-align:right; font-variant-numeric: tabular-nums; }
    /* highlight hàng đã chọn */
    tr.is-selected{
      background:#fff7ed;
      box-shadow:0 0 0 2px rgba(249,115,22,.22) inset;
    }
    tr.is-selected td{ border-top-color:#ffd7ba !important; }
    /* style checkbox cột đầu cho dễ bấm */
    td.sel, th.sel{ width:48px; }
    td.sel input[type="checkbox"], th.sel input[type="checkbox"]{ cursor:pointer; }

block content
  h2(style="margin:0 0 16px") TỒN KHO SẢN PHẨM

  // KPI Cards
  .cards(style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:16px")
    .card(style="padding:16px;border-radius:16px;background:#fff;box-shadow:0 8px 24px rgba(16,24,40,.06);display:flex;justify-content:space-between;align-items:center")
      .left
        .lbl(style="color:#475467") Tổng số mặt hàng
        .val(style="font-size:28px;font-weight:700") #{kpis.totalProductItems}
        span(style="color:#98A2B3") (Mục)
      .right(style="color:#f97316")
        +iconTotal()
    .card(style="padding:16px;border-radius:16px;background:#fff;box-shadow:0 8px 24px rgba(16,24,40,.06);display:flex;justify-content:space-between;align-items:center")
      .left
        .lbl(style="color:#475467") Sản phẩm còn hàng
        .val(style="font-size:28px;font-weight:700") #{kpis.inStockProduct}
        span(style="color:#98A2B3") (Mục)
      .right(style="color:#f97316")
        +iconInStock()
    .card(style="padding:16px;border-radius:16px;background:#fff;box-shadow:0 8px 24px rgba(16,24,40,.06);display:flex;justify-content:space-between;align-items:center")
      .left
        .lbl(style="color:#475467") Sản phẩm hết hàng
        .val(style="font-size:28px;font-weight:700") #{kpis.outOfStockProduct}
        span(style="color:#98A2B3") (Mục)
      .right(style="color:#f97316")
        +iconOutStock()
    .card(style="padding:16px;border-radius:16px;background:#fff;box-shadow:0 8px 24px rgba(16,24,40,.06);display:flex;justify-content:space-between;align-items:center")
      .left
        .lbl(style="color:#475467") Đơn hàng hoàn tất
        .val(style="font-size:28px;font-weight:700") #{kpis.completedOrders}
        span(style="color:#98A2B3") (Đơn hàng)
      .right(style="color:#f97316")
        +iconComplete()

  // Product list (single-warehouse)
  .card(style="padding:0;border-radius:18px;box-shadow:0 8px 24px rgba(16,24,40,.06)")
    .perf-hd(style="display:flex;justify-content:space-between;align-items:center;padding:16px")
      .ttl Tất cả sản phẩm
      .seg
        .filter(style="position:relative;display:inline-block")
          button#filterBtn(type="button" style="padding:6px 10px;border:1px solid #e5e7eb;background:#fff;border-radius:10px;cursor:pointer;min-width:140px")
            | #{filterLabel} ▾
          .menu#filterMenu(style="position:absolute;right:0;top:110%;min-width:180px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 8px 24px rgba(16,24,40,.06);padding:8px;display:none;z-index:30")
            a(href="/admin/inventory?range=today" style="display:block;padding:8px 10px;border-radius:8px;margin:2px 0") Hôm nay
            a(href="/admin/inventory?range=week"  style="display:block;padding:8px 10px;border-radius:8px;margin:2px 0") Tuần này
            a(href="/admin/inventory?range=month" style="display:block;padding:8px 10px;border-radius:8px;margin:2px 0") Tháng này
            a(href="/admin/inventory?range=year"  style="display:block;padding:8px 10px;border-radius:8px;margin:2px 0") Năm nay

    table(style="width:100%; border-collapse:separate; border-spacing:0")
      thead
        tr
          th.sel(style="text-align:left; padding:14px 16px; border-bottom:1px solid #eef0f5")
            // Select all
            input#ckAll(type="checkbox" title="Select all")
          each h in ['Mã SP','Sản phẩm','Tồn kho','Đã giữ','Đã bán','Doanh thu','Thao tác']
            th(style="text-align:left; padding:14px 16px; border-bottom:1px solid #eef0f5")= h
      tbody
        if rows && rows.length
          each r in rows
            tr(data-id=r.productId)
              td.sel(style="padding:14px 16px; border-top:1px solid #f2f3f7")
                input.row-ck(type="checkbox" name="select[]" value=r.productId title=`Select ${r.title}`)
              td(style="padding:14px 16px; border-top:1px solid #f2f3f7")= r.productId
              td(style="padding:14px 16px; border-top:1px solid #f2f3f7")= r.title
              td.num(style="padding:14px 16px; border-top:1px solid #f2f3f7") #{r.onHand}
              td.num(style="padding:14px 16px; border-top:1px solid #f2f3f7") #{r.reserved}
              td.num(style="padding:14px 16px; border-top:1px solid #f2f3f7") #{r.sold}
              td.num(style="padding:14px 16px; border-top:1px solid #f2f3f7")= helpers.money(r.revenue || 0)
              td(style="padding:14px 16px; border-top:1px solid #f2f3f7")
                .actions(style="display:flex; gap:8px; align-items:center")
                  a(href=`/admin/products/${r.productId}` title="Xem" style="display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid #e5e7eb;border-radius:10px;background:#fff")
                    +ic_eye(18)
                  a(href=`/admin/products/${r.productId}/edit` title="Sửa" style="display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid #ffe0e0;border-radius:10px;background:#fff5f5")
                    +ic_edit(18)
        else
          tr
            td(colspan="8" style="padding:18px;text-align:center;color:#98A2B3") Không có dữ liệu.

  // Extra sections
  .grid2(style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px")
    .card(style="padding:16px;border-radius:18px;box-shadow:0 8px 24px rgba(16,24,40,.06)")
      h3(style="margin:0 0 12px") Tồn thấp (Top 10)
      if lowStock && lowStock.length
        table(style="width:100%")
          thead
            tr
              th(style="text-align:left;padding:8px 10px;border-bottom:1px solid #eef0f5") Sản phẩm
              th(style="text-align:right;padding:8px 10px;border-bottom:1px solid #eef0f5") Tồn kho
          tbody
            each p in lowStock
              tr
                td(style="padding:8px 10px;border-top:1px solid #f2f3f7")= p.title
                td.num(style="padding:8px 10px;border-top:1px solid #f2f3f7")= p.stock
      else
        p Không có dữ liệu.

    .card(style="padding:16px;border-radius:18px;box-shadow:0 8px 24px rgba(16,24,40,.06)")
      h3(style="margin:0 0 12px") Bán chạy (#{filterLabel})
      if topSelling && topSelling.length
        table(style="width:100%")
          thead
            tr
              th(style="text-align:left;padding:8px 10px;border-bottom:1px solid #eef0f5") Sản phẩm
              th(style="text-align:right;padding:8px 10px;border-bottom:1px solid #eef0f5") Đã bán
          tbody
            each x in topSelling
              tr
                td(style="padding:8px 10px;border-top:1px solid #f2f3f7")= x.title
                td.num(style="padding:8px 10px;border-top:1px solid #f2f3f7")= x.sold
      else
        p Không có dữ liệu.

block scripts
  script.
    (function(){
      // Filter dropdown
      const b = document.getElementById('filterBtn'), m = document.getElementById('filterMenu');
      if(b&&m){
        b.addEventListener('click', ()=> m.style.display = (m.style.display==='block'?'none':'block'));
        document.addEventListener('click', (e)=>{ if(!m.contains(e.target)&&!b.contains(e.target)) m.style.display='none';});
      }

      // Row highlight khi tick
      function markRow(cb){
        const tr = cb.closest('tr');
        if(!tr) return;
        tr.classList.toggle('is-selected', cb.checked);
      }
      document.querySelectorAll('input.row-ck').forEach(cb=>{
        cb.addEventListener('change', ()=> markRow(cb));
        if(cb.checked) markRow(cb);
      });

      // Select all
      const ckAll = document.getElementById('ckAll');
      if(ckAll){
        ckAll.addEventListener('change', ()=>{
          document.querySelectorAll('input.row-ck').forEach(cb=>{
            cb.checked = ckAll.checked;
            markRow(cb);
          });
        });
      }
    })();
