extends ../../layouts/default
include ../../mixins/icons

block head
  style.
    .pager-wrap{display:flex;justify-content:flex-end;margin:16px 0}
    .pager{
      display:flex;align-items:center;gap:0;
      border:1px solid #eef0f5;border-radius:16px;overflow:hidden;
      background:#fff;box-shadow:0 2px 8px rgba(16,24,40,.04)
    }
    .pager a,.pager span{
      padding:8px 14px;min-width:40px;justify-content:center;
      display:inline-flex;align-items:center;text-decoration:none;
      border-right:1px solid #eef0f5;color:#374151;background:#fff;
      font-weight:600
    }
    .pager a:hover{background:#f9fafb}
    .pager .active{background:#f97316;color:#fff;border-right-color:#f97316}
    .pager .disabled{color:#9ca3af;background:#f9fafb;pointer-events:none}
    .pager :last-child{border-right:none}

    /* ===== Row select highlight ===== */
    th.sel, td.sel { width:48px }
    td.sel input[type="checkbox"], th.sel input[type="checkbox"]{ cursor:pointer }
    tbody tr.is-selected{
      background:#fff7ed;
      box-shadow:0 0 0 2px rgba(249,115,22,.22) inset;
    }
    tbody tr.is-selected td{ border-top-color:#ffd7ba !important; }

block content
  - const rows = Array.isArray(products) && products.length ? products : []

  h2(style="margin:0 0 16px") PRODUCT LIST

  .card(style="padding:0;border-radius:18px;box-shadow:0 8px 24px rgba(16,24,40,.06)")
    .perf-hd
      .ttl All Product List
      .seg
        button.btn.btn-dark(onclick="location.href='/admin/products/create'" style="background:#E6612A") Add Product

        //- Dropdown filter ranges
        .filter(style="position:relative;display:inline-block;margin-left:8px")
          button#filterBtn(
            type="button"
            style="padding:6px 10px;border:1px solid #e5e7eb;background:#fff;border-radius:10px;cursor:pointer;min-width:140px;display:inline-flex;align-items:center;justify-content:space-between;gap:6px"
          )
            span #{filterLabel || 'This Month'}
            span ▾
          .menu#filterMenu(style="position:absolute;right:0;top:110%;min-width:180px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 8px 24px rgba(16,24,40,.06);padding:8px;display:none;z-index:30")
            a(href="/admin/products?range=today" style=`display:block;padding:8px 10px;border-radius:8px;margin:2px 0;${range==='today'?'background:#f6f7fb;':''}`) Today
            a(href="/admin/products?range=week"  style=`display:block;padding:8px 10px;border-radius:8px;margin:2px 0;${range==='week'?'background:#f6f7fb;':''}`) This Week
            a(href="/admin/products?range=month" style=`display:block;padding:8px 10px;border-radius:8px;margin:2px 0;${range==='month'?'background:#f6f7fb;':''}`) This Month
            a(href="/admin/products?range=year"  style=`display:block;padding:8px 10px;border-radius:8px;margin:2px 0;${range==='year'?'background:#f6f7fb;':''}`) This Year

    table(style="width:100%; border-collapse:separate; border-spacing:0")
      thead
        tr
          th.sel(style="padding:14px 16px; border-bottom:1px solid #eef0f5")
            input#ckAll(type="checkbox" title="Select all")
          th(style="text-align:left; padding:14px 16px; border-bottom:1px solid #eef0f5") Product Name & Size
          th(style="text-align:left; padding:14px 16px; border-bottom:1px solid #eef0f5") Price
          th(style="text-align:left; padding:14px 16px; border-bottom:1px solid #eef0f5") Stock
          th(style="text-align:left; padding:14px 16px; border-bottom:1px solid #eef0f5") Category
          th(style="text-align:left; padding:14px 16px; border-bottom:1px solid #eef0f5") Rating
          th(style="text-align:left; padding:14px 16px; border-bottom:1px solid #eef0f5") Action
      tbody
        each p in rows
          tr(data-id=p.id)
            td.sel(style="padding:14px 16px; border-top:1px solid #f2f3f7")
              input.row-ck(type="checkbox" value=p.id title=`Select ${p.name}`)

            td(style="padding:14px 16px; border-top:1px solid #f2f3f7")
              .prodCell(style="display:flex; align-items:center; gap:14px")
                img(src=p.img alt=p.name style="width:52px;height:52px;border-radius:12px;object-fit:cover;background:#f3f4f6")
                .info
                  .name(style="font-weight:700")= p.name
                  .muted(style="color:#8c98a9; font-size:13px") Size :
                    |  #{Array.isArray(p.sizes)?p.sizes.join(' , '):p.sizes}

            td(style="padding:14px 16px; border-top:1px solid #f2f3f7")= p.priceText

            td(style="padding:14px 16px; border-top:1px solid #f2f3f7")
              span(style="font-weight:700") #{p.left}
              |  Item Left
              br
              span(style="color:#8c98a9; font-size:13px") #{p.sold} Sold

            //- Category
            td(style="padding:14px 16px; border-top:1px solid #f2f3f7")= p.category

            //- Rating
            td(style="padding:14px 16px; border-top:1px solid #f2f3f7")
              span(style="display:inline-flex;align-items:center;gap:6px;background:#eef2ff;border-radius:10px;padding:4px 8px;color:#f59e0b")
                +ic_star(14)
                span(style="color:#111") #{(p.rating || 0).toFixed(1)}
              span(style="color:#8c98a9; margin-left:8px") #{p.reviews || 0} Review

            td(style="padding:14px 16px; border-top:1px solid #f2f3f7")
              .actions(style="display:flex; gap:8px; align-items:center")
                a(href=`/admin/products/${p.id}` title="View" style="display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid #e5e7eb;border-radius:10px;background:#fff")
                  +ic_eye()
                a(href=`/admin/products/${p.id}/edit` title="Edit" style="display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid #ffe0e0;border-radius:10px;background:#fff5f5")
                  +ic_edit()
                form.delete-form(method="post" action=`/admin/products/${p.id}/delete`)
                  button.btn-icon.btn-danger(
                    type="submit"
                    aria-label="Delete product"
                    data-confirm="Delete this product?"
                    style="display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid #ffe0e0;border-radius:10px;background:#fff5f5;cursor:pointer"
                  )
                    +ic_trash()

    //- ===== Pagination =====
    - const totalPages = Math.max(1, Math.ceil((pagination?.total || 0) / (pagination?.take || 10)));
    - const cur = pagination?.page || 1;
    - const take = pagination?.take || 10;
    - const q = `&take=${take}&range=${range || 'month'}`;

    if totalPages > 1
      nav.pager-wrap(aria-label="Pagination")
        .pager
          // Prev
          - const prev = Math.max(1, cur - 1);
          if cur > 1
            a(href=`?page=${prev}${q}`) Previous
          else
            span.disabled Previous

          // Numbers
          - for (let i = 1; i <= totalPages; i++) {
            if i === cur
              span.active= i
            else
              a(href=`?page=${i}${q}`)= i
          - }

          // Next
          - const next = Math.min(totalPages, cur + 1);
          if cur < totalPages
            a(href=`?page=${next}${q}`) Next
          else
            span.disabled Next

block scripts
  script.
    (function(){
      // Filter dropdown
      const btn = document.getElementById('filterBtn');
      const menu = document.getElementById('filterMenu');
      if(btn && menu){
        btn.addEventListener('click', () => {
          menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
        });
        document.addEventListener('click', (e) => {
          if(!menu.contains(e.target) && !btn.contains(e.target)) menu.style.display = 'none';
        });
      }

      // Delete confirm
      document.addEventListener('click', function (e) {
        const del = e.target.closest('form.delete-form button[type="submit"]');
        if (!del) return;
        const msg = del.getAttribute('data-confirm') || 'Are you sure?';
        if (!confirm(msg)) e.preventDefault();
      });

      // ===== Checkbox: select all + highlight =====
      function markRow(cb){
        const tr = cb.closest('tr');
        if(!tr) return;
        tr.classList.toggle('is-selected', cb.checked);
      }
      const ckAll = document.getElementById('ckAll');
      const rowCks = Array.from(document.querySelectorAll('input.row-ck'));

      rowCks.forEach(cb=>{
        cb.addEventListener('change', ()=>{
          markRow(cb);
          if(ckAll){
            const allOn = rowCks.length && rowCks.every(x=>x.checked);
            ckAll.checked = allOn;
            ckAll.indeterminate = !allOn && rowCks.some(x=>x.checked);
          }
        });
        if(cb.checked) markRow(cb); // sync khi render lại
      });

      if(ckAll){
        ckAll.addEventListener('change', ()=>{
          rowCks.forEach(cb=>{
            cb.checked = ckAll.checked;
            markRow(cb);
          });
          ckAll.indeterminate = false;
        });
      }
    })();
